"use strict";(self.webpackChunkdata_derp=self.webpackChunkdata_derp||[]).push([[1311],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),h=r,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||o;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3411:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return c},default:function(){return d}});var a=n(3117),r=n(102),o=(n(7294),n(3905)),i=["components"],s={sidebar_position:8},l="Wrangling with Spark",p={unversionedId:"data-transformation/wrangling-with-spark",id:"data-transformation/wrangling-with-spark",title:"Wrangling with Spark",description:"Working with Databricks",source:"@site/docs/data-transformation/wrangling-with-spark.md",sourceDirName:"data-transformation",slug:"/data-transformation/wrangling-with-spark",permalink:"/docs/data-transformation/wrangling-with-spark",editUrl:"https://github.com/data-derp/data-derp.github.io/tree/master/docs/docs/data-transformation/wrangling-with-spark.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8},sidebar:"tutorialSidebar",previous:{title:"Spark on Kubernetes",permalink:"/docs/data-transformation/spark-on-kubernetes"},next:{title:"Quiz",permalink:"/docs/data-transformation/quiz"}},c=[{value:"Working with Databricks",id:"working-with-databricks",children:[],level:2},{value:"What&#39;s Missing from These Notebooks?",id:"whats-missing-from-these-notebooks",children:[],level:2},{value:"Window Functions",id:"window-functions",children:[],level:2},{value:"Python UDFs",id:"python-udfs",children:[{value:"How can I bring in my own custom Python logic?",id:"how-can-i-bring-in-my-own-custom-python-logic",children:[],level:3},{value:"But..how can we be more efficient when switching between the JVM and Python??",id:"buthow-can-we-be-more-efficient-when-switching-between-the-jvm-and-python",children:[],level:3},{value:"Wowww, how do I actually use Pandas UDFs then?",id:"wowww-how-do-i-actually-use-pandas-udfs-then",children:[],level:3}],level:2},{value:"A Deeper Reference",id:"a-deeper-reference",children:[],level:2}],u={toc:c};function d(e){var t=e.components,s=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},u,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"wrangling-with-spark"},"Wrangling with Spark"),(0,o.kt)("h2",{id:"working-with-databricks"},"Working with Databricks"),(0,o.kt)("p",null,"We'll walk through some of the basic transformation methods using notebooks"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://community.cloud.databricks.com/login.html"},"Create a Commmunity Edition Account")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/data-derp/small-exercises/raw/master/databricks-spark-training.dbc"},"Download Exercises")),(0,o.kt)("li",{parentName:"ol"},"Upload the .dbc file to Databricks\n",(0,o.kt)("img",{alt:"databricks-import.png",src:n(5953).Z}))),(0,o.kt)("h2",{id:"whats-missing-from-these-notebooks"},"What's Missing from These Notebooks?"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"cool-stuff-missing.png",src:n(4020).Z})),(0,o.kt)("p",null,"Short Answer:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The really cool stuff"),(0,o.kt)("li",{parentName:"ul"},"Window Functions"),(0,o.kt)("li",{parentName:"ul"},"Pandas UDFs (Vectorised UDFs)")),(0,o.kt)("h2",{id:"window-functions"},"Window Functions"),(0,o.kt)("p",null,"Just make sure you understand everything about window function semantics"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"partitionBy",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"similar to groupBy (but doesn\u2019t reduce/aggregate information down to a single row)"))),(0,o.kt)("li",{parentName:"ul"},"orderBy",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Just FYI, you can orderBy(F.col(\u201cmyColumn\u201d).desc()) for descending order."))),(0,o.kt)("li",{parentName:"ul"},"rowsBetween",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"You should look up the default arguments for different window functions (e.g. lag, lead, first, last, max, min, row_number)"))),(0,o.kt)("li",{parentName:"ul"},"rangeBetween\nCan you explain the difference between rowsBetween and rangeBetween?")),(0,o.kt)("p",null,"These are all also concepts in SQL."),(0,o.kt)("h2",{id:"python-udfs"},"Python UDFs"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"python-udfs.png",src:n(2279).Z})),(0,o.kt)("h3",{id:"how-can-i-bring-in-my-own-custom-python-logic"},"How can I bring in my own custom Python logic?"),(0,o.kt)("p",null,"(needs other libraries, not available as pyspark built-in functions)"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Basic Answer:")," ",(0,o.kt)("a",{parentName:"p",href:"https://docs.databricks.com/spark/latest/spark-sql/udf-python-pandas.html"},"Python UDFs")),(0,o.kt)("p",null,"How does this work? "),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"JVM serializes data and sends it to the Python process "),(0,o.kt)("li",{parentName:"ul"},"Python process deserializes, then serializes it back to the JVM "),(0,o.kt)("li",{parentName:"ul"},"JVM deserializes the data for running next operations/steps")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"python-udf-execution.png",src:n(4579).Z})),(0,o.kt)("h3",{id:"buthow-can-we-be-more-efficient-when-switching-between-the-jvm-and-python"},"But..how can we be more efficient when switching between the JVM and Python??"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Basic Answer:")," Vectorization"),(0,o.kt)("p",null,"How does this work? (the Apache Arrow project is basically dedicated to this!)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Batches/chunks of a single/multiple column(s) are serialized compactly/efficiently then sent to the Python process"),(0,o.kt)("li",{parentName:"ul"},"Which Python library is really good at vectorized operations on data again?",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Pandas! uses NumPy (written in C) under the hood"))),(0,o.kt)("li",{parentName:"ul"},"Chunks of data are serialized then finally sent back to the JVM")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"A pandas user-defined function (UDF)\u2014also known as vectorized UDF\u2014is a user-defined function that uses Apache Arrow to transfer data and pandas to work with the data. pandas UDFs allow vectorized operations that can increase performance up to 100x compared to row-at-a-time Python UDFs. (",(0,o.kt)("a",{parentName:"p",href:"https://docs.databricks.com/spark/latest/spark-sql/udf-python-pandas.html#pandas-user-defined-functions"},"Reference"),")")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"apply-in-pandas.png",src:n(6601).Z}),"\nThis even allows you to run custom logic per each group of data in a distributed manner:"),(0,o.kt)("p",null,"Pandas DataFrame ",(0,o.kt)("strong",{parentName:"p"},"IN"),"\nPandas DataFrame ",(0,o.kt)("strong",{parentName:"p"},"OUT"),"\nThis is ",(0,o.kt)("strong",{parentName:"p"},"massive"),"."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.databricks.com/spark/latest/spark-sql/pandas-function-apis.html"},"Reference Docs")),(0,o.kt)("h3",{id:"wowww-how-do-i-actually-use-pandas-udfs-then"},"Wowww, how do I actually use Pandas UDFs then?"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Basic Answer:")," Learn the different types of ",(0,o.kt)("a",{parentName:"p",href:"https://docs.databricks.com/spark/latest/spark-sql/udf-python-pandas.html"},"Pandas UDFs")," AND ",(0,o.kt)("a",{parentName:"p",href:"https://docs.databricks.com/spark/latest/spark-sql/pandas-function-apis.html"},"Pandas Functions APIs")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Example blog post (",(0,o.kt)("a",{parentName:"li",href:"https://databricks.com/blog/2017/10/30/introducing-vectorized-udfs-for-pyspark.html"},"potentially outdated"),")"),(0,o.kt)("li",{parentName:"ul"},"Series to Series (these can often directly replace your Python UDFs)"),(0,o.kt)("li",{parentName:"ul"},"Grouped Map (Pandas Functions APIs)",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"This is ",(0,o.kt)("strong",{parentName:"li"},"THE holy grail"),", you can parallelize data processing by treating each \u201cgroup\u201d as an independent Pandas DataFrame")))),(0,o.kt)("h2",{id:"a-deeper-reference"},"A Deeper Reference"),(0,o.kt)("p",null,"Check out O'Reilly's ",(0,o.kt)("a",{parentName:"p",href:"https://www.oreilly.com/library/view/learning-spark/9781449359034/"},'"Learning Spark" book')))}d.isMDXComponent=!0},6601:function(e,t,n){t.Z=n.p+"assets/images/apply-in-pandas-995df03d9f3e5609cc9e6cc3a0d07170.png"},4020:function(e,t,n){t.Z=n.p+"assets/images/cool-stuff-missing-6e59b383a56946eaccb9d92a20b2e4c6.png"},5953:function(e,t,n){t.Z=n.p+"assets/images/databricks-import-66829f40b9d3975a50b37dd6da4c7cce.png"},4579:function(e,t,n){t.Z=n.p+"assets/images/python-udf-execution-62744a99a8cbec52b3d8b11a2b0ee526.png"},2279:function(e,t,n){t.Z=n.p+"assets/images/python-udfs-1d880d3403379f4501da56fd52fe304e.png"}}]);